<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lista de Revistas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .journal-card-img {
      height: 200px;
      object-fit: cover;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <a class="btn btn-link mb-3" href="/journals.html">&larr; Voltar</a>
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
      <h1 class="h3 mb-0">Revistas Cadastradas</h1>
      <a href="/register-journal.html" class="btn btn-primary">Registrar Nova Revista</a>
    </div>
    <div id="page-alert"></div>
    <div class="container mt-4">
      <h2>Revistas WOS</h2>
      <hr>
      <div id="wos-grid" class="row row-cols-1 row-cols-md-3 g-4 mb-5"></div>

      <h2>Revistas SCOPUS</h2>
      <hr>
      <div id="scopus-grid" class="row row-cols-1 row-cols-md-3 g-4"></div>
    </div>
  </div>

  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Editar Revista</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="edit-form" novalidate>
            <input type="hidden" id="edit-id">
            <div class="mb-3">
              <label class="form-label" for="edit-name">Nome da Revista</label>
              <input type="text" class="form-control" id="edit-name" required>
            </div>
            <div class="mb-3">
              <label class="form-label" for="edit-issn">ISSN</label>
              <input type="text" class="form-control" id="edit-issn">
            </div>
            <div class="mb-3">
              <label class="form-label" for="edit-impact">Impact Factor</label>
              <input type="number" step="0.01" class="form-control" id="edit-impact">
            </div>
            <div class="mb-3">
              <label class="form-label" for="edit-quartile">Quartil</label>
              <input type="text" class="form-control" id="edit-quartile" placeholder="Q1, Q2...">
            </div>
            <div class="mb-3">
              <label class="form-label" for="edit-image">URL da Foto da Revista</label>
              <input type="text" class="form-control" id="edit-image" placeholder="https://exemplo.com/imagem.jpg">
            </div>
            <div class="mb-3">
              <label class="form-label" for="edit-type">Tipo</label>
              <select class="form-select" id="edit-type" required>
                <option value="">Selecione...</option>
                <option value="WOS">WOS</option>
                <option value="SCOPUS">SCOPUS</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary">Salvar Alterações</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const placeholderImg = 'https://via.placeholder.com/400x250?text=Revista';
    const wosGrid = document.getElementById('wos-grid');
    const scopusGrid = document.getElementById('scopus-grid');
    const pageAlert = document.getElementById('page-alert');
    const editForm = document.getElementById('edit-form');
    const editModalElement = document.getElementById('editModal');
    const modal = new bootstrap.Modal(editModalElement);

    let journalsCache = [];

    function showMessage(message, type = 'success') {
      pageAlert.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>`;
    }

    function clearGrid() {
      wosGrid.innerHTML = '';
      scopusGrid.innerHTML = '';
    }

    function buildCard(journal) {
      const col = document.createElement('div');
      col.className = 'col';
      col.innerHTML = `
        <div class="card h-100 shadow-sm">
          <img src="${journal.image_url || placeholderImg}" class="card-img-top journal-card-img" alt="Imagem da revista">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title">${journal.name}</h5>
            <p class="card-text mb-1"><strong>Impact Factor:</strong> ${journal.impact_factor ?? 'N/A'}</p>
            <p class="card-text mb-3"><strong>Quartil:</strong> ${journal.quartile || 'N/A'}</p>
            <div class="mt-auto d-flex gap-2">
              <button class="btn btn-primary btn-sm" data-action="edit" data-id="${journal.id}">Editar</button>
              <button class="btn btn-danger btn-sm" data-action="delete" data-id="${journal.id}">Excluir</button>
            </div>
          </div>
        </div>
      `;
      return col;
    }

    function renderJournals() {
      clearGrid();
      const wos = journalsCache.filter((journal) => journal.type === 'WOS');
      const scopus = journalsCache.filter((journal) => journal.type === 'SCOPUS');

      if (!wos.length) {
        wosGrid.innerHTML = '<div class="col"><div class="alert alert-info">Nenhuma revista WOS cadastrada.</div></div>';
      } else {
        wos.forEach((journal) => {
          wosGrid.appendChild(buildCard(journal));
        });
      }

      if (!scopus.length) {
        scopusGrid.innerHTML = '<div class="col"><div class="alert alert-info">Nenhuma revista SCOPUS cadastrada.</div></div>';
      } else {
        scopus.forEach((journal) => {
          scopusGrid.appendChild(buildCard(journal));
        });
      }
    }

    async function loadJournals() {
      try {
        const response = await fetch('/api/journals');
        journalsCache = await response.json();
        renderJournals();
      } catch (error) {
        showMessage('Erro ao carregar revistas.', 'danger');
      }
    }

    function fillEditForm(journal) {
      document.getElementById('edit-id').value = journal.id;
      document.getElementById('edit-name').value = journal.name || '';
      document.getElementById('edit-issn').value = journal.issn || '';
      document.getElementById('edit-impact').value = journal.impact_factor ?? '';
      document.getElementById('edit-quartile').value = journal.quartile || '';
      document.getElementById('edit-type').value = journal.type || '';
      document.getElementById('edit-image').value = journal.image_url || '';
    }

    async function handleGridClick(event) {
      const button = event.target.closest('button[data-action]');
      if (!button) return;
      const journalId = button.getAttribute('data-id');
      const action = button.getAttribute('data-action');

      if (action === 'edit') {
        const journal = journalsCache.find((item) => String(item.id) === String(journalId));
        if (!journal) return;
        fillEditForm(journal);
        modal.show();
      }

      if (action === 'delete') {
        if (!confirm('Tem certeza que deseja excluir esta revista?')) return;
        try {
          const response = await fetch(`/api/journals/${journalId}`, { method: 'DELETE' });
          if (!response.ok) {
            throw new Error('Erro ao excluir');
          }
          journalsCache = journalsCache.filter((item) => String(item.id) !== String(journalId));
          renderJournals();
          showMessage('Revista excluída com sucesso.');
        } catch (error) {
          showMessage('Não foi possível excluir a revista.', 'danger');
        }
      }
    }

    wosGrid.addEventListener('click', handleGridClick);
    scopusGrid.addEventListener('click', handleGridClick);

    editForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const id = document.getElementById('edit-id').value;
      const payload = {
        name: document.getElementById('edit-name').value,
        issn: document.getElementById('edit-issn').value || null,
        impact_factor: document.getElementById('edit-impact').value || null,
        quartile: document.getElementById('edit-quartile').value || null,
        type: document.getElementById('edit-type').value,
        image_url: document.getElementById('edit-image').value || null
      };

      try {
        const response = await fetch(`/api/journals/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error('Erro ao atualizar');
        }

        modal.hide();
        await loadJournals();
        showMessage('Revista atualizada com sucesso.');
      } catch (error) {
        showMessage('Não foi possível atualizar a revista.', 'danger');
      }
    });

    loadJournals();
  </script>
</body>
</html>
