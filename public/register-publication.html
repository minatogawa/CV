<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registrar Publicação</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-5">
    <a class="btn btn-link mb-3" href="/index.html">&larr; Voltar ao Menu</a>
    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="card-title mb-4">Registrar Publicação</h2>
        <div id="alert-placeholder"></div>
        <div class="mb-3">
          <label class="form-label" for="unstructured-text">Cole abaixo o texto desestruturado da publicação</label>
          <textarea id="unstructured-text" class="form-control" rows="8" placeholder="Ex.: Autores, título, ano, DOI, revista..."></textarea>
        </div>
        <button class="btn btn-primary" id="parse-button">Processar Texto com IA</button>
      </div>
    </div>
  </div>

  <div class="modal fade" id="publication-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Detalhes da Publicação</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="modal-form" novalidate>
            <div class="mb-3">
              <label class="form-label" for="modal-authors">Autores</label>
              <input type="text" class="form-control" id="modal-authors" required>
            </div>
            <div class="mb-3">
              <label class="form-label" for="modal-title">Título</label>
              <input type="text" class="form-control" id="modal-title" required>
            </div>
            <div class="mb-3">
              <label class="form-label" for="modal-year">Ano</label>
              <input type="number" class="form-control" id="modal-year" min="1900" max="2100" required>
            </div>
            <div class="mb-3">
              <label class="form-label" for="modal-doi">DOI</label>
              <input type="text" class="form-control" id="modal-doi">
            </div>
            <div class="mb-3">
              <label class="form-label" for="modal-journal_id">Revista</label>
              <select class="form-select" id="modal-journal_id"></select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="save-publication-button">Salvar Publicação</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const textarea = document.getElementById('unstructured-text');
    const parseButton = document.getElementById('parse-button');
    const alertPlaceholder = document.getElementById('alert-placeholder');
    const modalElement = document.getElementById('publication-modal');
    const publicationModal = new bootstrap.Modal(modalElement);
    const modalForm = document.getElementById('modal-form');
    const modalAuthors = document.getElementById('modal-authors');
    const modalTitle = document.getElementById('modal-title');
    const modalYear = document.getElementById('modal-year');
    const modalDoi = document.getElementById('modal-doi');
    const modalJournalSelect = document.getElementById('modal-journal_id');
    const saveButton = document.getElementById('save-publication-button');
    let journalsCache = [];

    function showAlert(message, type = 'success') {
      alertPlaceholder.innerHTML = `<div class="alert alert-${type}" role="alert">${message}</div>`;
    }

    function populateJournalOptions(selected) {
      modalJournalSelect.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'Selecione uma revista...';
      placeholder.disabled = true;
      placeholder.selected = true;
      modalJournalSelect.appendChild(placeholder);

      journalsCache.forEach((journal) => {
        const option = document.createElement('option');
        option.value = String(journal.id);
        option.textContent = journal.name;
        modalJournalSelect.appendChild(option);
      });

      if (selected && [...modalJournalSelect.options].some((opt) => opt.value === selected)) {
        modalJournalSelect.value = selected;
      } else {
        modalJournalSelect.value = '';
      }
    }

    async function loadJournals() {
      try {
        const response = await fetch('/api/journals');
        journalsCache = await response.json();
        populateJournalOptions();
      } catch (error) {
        showAlert('Erro ao carregar revistas.', 'danger');
      }
    }

    parseButton.addEventListener('click', async () => {
      const text = textarea.value.trim();
      if (!text) {
        showAlert('Cole um texto antes de processar.', 'warning');
        return;
      }

      showAlert('Processando texto com IA, aguarde...', 'info');
      try {
        const response = await fetch('/api/parse_publication', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });

        if (!response.ok) {
          throw new Error('Erro no processamento');
        }

        const data = await response.json();
        modalAuthors.value = data.authors || '';
        modalTitle.value = data.title || '';
        modalYear.value = data.year || '';
        modalDoi.value = data.doi || '';

        const selectedJournal = data.matched_journal_id != null ? String(data.matched_journal_id) : '';
        populateJournalOptions(selectedJournal);

        publicationModal.show();
        showAlert('Texto processado. Revise os campos antes de salvar.', 'success');
      } catch (error) {
        console.error(error);
        showAlert('Não foi possível processar o texto com IA.', 'danger');
      }
    });

    saveButton.addEventListener('click', async () => {
      const selectedJournalId = modalJournalSelect.value;
      if (!selectedJournalId) {
        alert('Erro: Você deve selecionar uma revista. Se a revista não estiver na lista, cadastre-a primeiro no menu Revistas.');
        return;
      }

      const payload = {
        authors: modalAuthors.value.trim(),
        title: modalTitle.value.trim(),
        year: modalYear.value ? Number(modalYear.value) : null,
        doi: modalDoi.value.trim() || null,
        journal_id: Number(selectedJournalId)
      };

      if (!payload.authors || !payload.title || !payload.year) {
        showAlert('Preencha autores, título e ano para salvar.', 'warning');
        return;
      }

      try {
        const response = await fetch('/api/publications', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error('Erro ao salvar publicação');
        }

        modalForm.reset();
        populateJournalOptions();
        publicationModal.hide();
        textarea.value = '';
        showAlert('Publicação salva com sucesso!', 'success');
      } catch (error) {
        console.error(error);
        showAlert('Não foi possível salvar a publicação.', 'danger');
      }
    });

    loadJournals();
  </script>
</body>
</html>
